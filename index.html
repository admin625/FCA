<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCA Content Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
         
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 700;
        }
        
        .subtitle {
            color: #64748b;
            margin-bottom: 30px;
            font-size: 16px;
        }

        /* Tier Badge */
        .tier-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tier-trial {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .tier-basic {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .tier-pro {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: white;
        }

        .tier-premium {
            background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%);
            color: white;
        }

        .tier-studio {
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
            color: white;
        }

        /* Tier Info Box */
        .tier-info {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            display: none;
        }

        .tier-info.show {
            display: block;
        }

        .tier-info h3 {
            color: #0369a1;
            font-size: 15px;
            margin-bottom: 8px;
        }

        .tier-info p {
            color: #0c4a6e;
            font-size: 14px;
            line-height: 1.5;
        }

        .tier-info.trial {
            background: #f0fdf4;
            border-color: #10b981;
        }

        .tier-info.trial h3 {
            color: #047857;
        }

        .tier-info.trial p {
            color: #065f46;
        }

        .tier-info.expired {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .tier-info.expired h3 {
            color: #b91c1c;
        }

        .tier-info.expired p {
            color: #991b1b;
        }
        
        .section-header {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            padding: 14px 20px;
            margin: 30px -40px 25px -40px;
            font-weight: 600;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        
        .form-group {
            margin-bottom: 25px;
        }

        .form-group.hidden {
            display: none;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #1e293b;
            font-weight: 600;
            font-size: 14px;
        }
        
        .required {
            color: #f97316;
            margin-left: 3px;
        }
        
        .helper-text {
            font-size: 13px;
            color: #64748b;
            font-weight: 400;
            margin-top: 6px;
            font-style: italic;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="url"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: white;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        input:disabled,
        select:disabled,
        textarea:disabled {
            background: #f1f5f9;
            cursor: not-allowed;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Instructor Management Section */
        .instructor-management {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            display: none;
        }

        .instructor-management.show {
            display: block;
        }

        .instructor-management h3 {
            color: #1e40af;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .add-instructor-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-instructor-form input {
            padding: 10px 12px;
            font-size: 14px;
        }

        .add-instructor-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .add-instructor-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .instructor-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .instructor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }

        .instructor-info {
            flex: 1;
        }

        .instructor-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .instructor-email {
            font-size: 13px;
            color: #64748b;
            margin-top: 2px;
        }

        .remove-instructor-btn {
            padding: 6px 14px;
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .remove-instructor-btn:hover {
            background: #fecaca;
            border-color: #fca5a5;
        }

        /* Photo Upload Section */
        .photo-upload-section {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload-section:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .photo-upload-section.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f1f5f9;
        }

        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-preview-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            position: relative;
        }

        .photo-preview-image {
            position: relative;
            width: 100%;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .photo-preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            font-weight: bold;
        }

        .photo-remove-btn:hover {
            background: rgba(0,0,0,0.9);
        }

        .photo-tags {
            margin-top: 8px;
        }

        .photo-tags-label {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
            display: block;
        }

        .photo-instructor-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        .photo-instructor-checkbox {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .photo-instructor-checkbox:hover {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .photo-instructor-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            cursor: pointer;
            accent-color: #2563eb;
        }

        .photo-instructor-checkbox label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            color: #1e293b;
        }
        
        /* NUMBER SELECTOR */
        .number-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .number-btn {
            width: 50px;
            height: 50px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            font-size: 18px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .number-btn:hover {
            border-color: #2563eb;
            background: #eff6ff;
            transform: translateY(-2px);
        }
        
        .number-btn.selected {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            border-color: #2563eb;
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }
        
        /* Platform Cards */
        .platform-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            background: #f8fafc;
            transition: all 0.3s ease;
        }
        
        .platform-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .platform-card.disabled {
            opacity: 0.5;
            background: #f1f5f9;
        }
        
        .platform-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .platform-header input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #2563eb;
        }
        
        .platform-header label {
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin: 0;
            flex-grow: 1;
            color: #1e293b;
        }
        
        .platform-controls {
            margin-left: 36px;
            display: none;
        }
        
        .platform-controls.active {
            display: block;
        }
        
        .control-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
        }
        
        .control-item label {
            font-size: 13px;
            margin-bottom: 10px;
            color: #475569;
            font-weight: 600;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }
        
        .checkbox-item:hover {
            border-color: #2563eb;
            background: #eff6ff;
            transform: translateY(-1px);
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #2563eb;
        }
        
        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }
        
        /* Toggle switch for preferences */
        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
        }
        
        .toggle-label {
            font-weight: 600;
            color: #1e293b;
            font-size: 15px;
        }
        
        .toggle-description {
            font-size: 13px;
            color: #64748b;
            margin-top: 4px;
            line-height: 1.4;
        }
        
        .toggle-switch {
            position: relative;
            width: 56px;
            height: 30px;
            flex-shrink: 0;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 30px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2563eb;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            box-shadow: 0 8px 20px rgba(249, 115, 22, 0.3);
            letter-spacing: 0.3px;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(249, 115, 22, 0.4);
        }
        
        .submit-btn:active {
            transform: translateY(-1px);
        }
        
        .submit-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Success Banner */
        .success-banner {
            display: none;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        
        .success-banner.show {
            display: block;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success-banner h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .success-banner p {
            font-size: 16px;
            opacity: 0.95;
        }
        
        .success-banner .email-note {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.3);
            font-size: 14px;
        }

        /* Loading State */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
            }
            
            .section-header {
                margin-left: -20px;
                margin-right: -20px;
            }
            
            .number-selector {
                gap: 6px;
            }
            
            .number-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }

            .add-instructor-form {
                grid-template-columns: 1fr;
            }

            .photo-preview-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <h2 style="color: #1e293b;">Creating Your Content...</h2>
            <p style="color: #64748b; margin-top: 10px;">This usually takes 2-3 minutes.</p>
        </div>
    </div>

    <div class="container">
        <!-- Success Banner -->
        <div class="success-banner" id="success-banner">
            <h2>‚úÖ Content Request Submitted!</h2>
            <p>Your personalized fitness content is being generated now.</p>
            <div class="email-note">
                üìß Check your email in 2-3 minutes for your content dashboard link.
            </div>
        </div>

        <h1>üéØ FCA Content Generator</h1>
        <p class="subtitle">AI-powered social media content for fitness professionals</p>
        
        <form id="contentForm">
            <!-- SECTION 0: EMAIL & TIER DETECTION -->
            <div class="section-header">Your Account</div>
            
            <div class="form-group">
                <label>Email Address: <span class="required">*</span></label>
                <input type="email" name="email" id="email" required placeholder="your@email.com" autocomplete="email">
                <div class="helper-text">Enter your email to verify your account</div>
            </div>
            
            <button type="button" id="verify-email-btn" style="
                width: 100%;
                padding: 16px;
                background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                margin-top: 10px;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(37, 99, 235, 0.4)';" 
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                Continue ‚Üí
            </button>

            <!-- Tier Info Display -->
            <div class="tier-info" id="tier-info"></div>

            <!-- Hidden fields for tier data -->
            <input type="hidden" name="client_id" id="client_id">
            <input type="hidden" name="user_tier" id="user_tier">
            <input type="hidden" name="user_role" id="user_role">
            <input type="hidden" name="studio_id" id="studio_id">
            <input type="hidden" name="studio_name" id="studio_name">
            <input type="hidden" name="posts_remaining" id="posts_remaining">
            
            <!-- Main Form (hidden until email verified) -->
            <div id="main-form" style="display: none;">
                
                <!-- SECTION 1: BRAND IDENTITY -->
                <div class="section-header">Your Brand Identity</div>
                
                <div class="form-group">
                    <label>I am a: <span class="required">*</span></label>
                    <select name="client_type" required id="client_type">
                        <option value="">Select one...</option>
                        <option value="instructor">Fitness Instructor/Personal Trainer</option>
                        <option value="gym_owner">Gym/Studio Owner</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>My coaching/brand style is: <span class="required">*</span></label>
                    <select name="brand_voice" required>
                        <option value="">Select one...</option>
                        <option value="motivational">Motivational & Inspiring - "You got this!" energy</option>
                        <option value="tough_love">Tough Love & No Excuses - Results-focused</option>
                        <option value="educational">Educational & Science-Based - Explain the why</option>
                        <option value="fun">Fun & Energetic - Make fitness entertaining</option>
                        <option value="mindful">Calm & Mindful - Wellness & balance focused</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>What makes you/your business different?</label>
                    <textarea name="unique_value" rows="3" placeholder="Example: I specialize in helping busy moms regain confidence through 30-minute HIIT sessions that fit their schedule"></textarea>
                    <div class="helper-text">2-3 sentences about your unique approach or specialty</div>
                </div>
                
                <div class="form-group">
                    <label>My main goal with social media is: <span class="required">*</span></label>
                    <select name="primary_goal" required>
                        <option value="">Select one...</option>
                        <option value="build_brand">Build my personal brand & following</option>
                        <option value="get_clients">Attract more clients</option>
                        <option value="inspire">Inspire and motivate my community</option>
                        <option value="establish_expert">Establish myself as an expert</option>
                        <option value="memberships">Increase gym memberships</option>
                        <option value="retention">Improve member retention</option>
                        <option value="fill_classes">Fill more classes</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Signature saying or catchphrase (Optional):</label>
                    <input type="text" name="signature_style" placeholder='Example: "No excuses, just results" or "Train like a warrior"'>
                    <div class="helper-text">Leave blank if you don't have one</div>
                </div>
                
                <!-- SECTION 2: AUDIENCE & FOCUS -->
                <div class="section-header">Target Audience & Focus</div>
                
                <div class="form-group">
                    <label>Target Audience: <span class="required">*</span></label>
                    <input type="text" name="target_audience" required placeholder="e.g., Women 25-45, Busy professionals, Seniors 60+">
                </div>
                
                <div class="form-group">
                    <label>Fitness Focus: <span class="required">*</span></label>
                    <input type="text" name="fitness_focus" required placeholder="e.g., HIIT, Yoga, Strength Training, CrossFit">
                </div>

                <div class="form-group">
                    <label>Primary Call-to-Action: <span class="required">*</span></label>
                    <select name="cta_type" required id="cta_type">
                        <option value="">What do you want your audience to do?</option>
                        <option value="book_consultation">Book a free consultation</option>
                        <option value="sign_up_trial">Sign up for a trial class</option>
                        <option value="dm_details">DM for more details</option>
                        <option value="link_bio">Click link in bio</option>
                        <option value="comment">Comment below</option>
                        <option value="visit_website">Visit my website</option>
                        <option value="tag_friend">Tag a friend</option>
                        <option value="custom">Custom CTA (specify below)</option>
                    </select>
                </div>

                <div class="form-group" id="custom-cta-group" style="display: none;">
                    <label>Custom Call-to-Action:</label>
                    <input type="text" name="custom_cta" placeholder="Enter your custom call-to-action">
                </div>
                
                <!-- SECTION 3: CONTENT PREFERENCES -->
                <div class="section-header">Content Preferences</div>

                <div class="form-group">
                    <label>Content themes to include (select all that apply):</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="content_themes" value="workout_tips" id="workout_tips">
                            <label for="workout_tips">Workout Tips</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="content_themes" value="nutrition" id="nutrition">
                            <label for="nutrition">Nutrition Advice</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="content_themes" value="motivation" id="motivation">
                            <label for="motivation">Motivation</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="content_themes" value="transformation" id="transformation">
                            <label for="transformation">Transformation Stories</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="content_themes" value="lifestyle" id="lifestyle">
                            <label for="lifestyle">Lifestyle/Balance</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="content_themes" value="technique" id="technique">
                            <label for="technique">Form & Technique</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Caption style preference:</label>
                    <select name="caption_style">
                        <option value="mixed">Mixed (variety of styles)</option>
                        <option value="short_punchy">Short & punchy (1-2 sentences)</option>
                        <option value="medium">Medium length (3-5 sentences)</option>
                        <option value="long_storytelling">Longer storytelling format</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Hashtag preference:</label>
                    <select name="hashtag_preference">
                        <option value="moderate">Moderate (5-10 relevant hashtags)</option>
                        <option value="minimal">Minimal (3-5 targeted hashtags)</option>
                        <option value="maximum">Maximum (15-20 hashtags)</option>
                        <option value="none">No hashtags</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Your go-to hashtags (Optional):</label>
                    <input type="text" name="custom_hashtags" placeholder="e.g., #YourBrandName #YourCityFit #CustomTag">
                    <div class="helper-text">These will be included in every post</div>
                </div>

                <div class="form-group">
                    <label>Topics or approaches to AVOID (Optional):</label>
                    <textarea name="avoid_topics" rows="2" placeholder="e.g., Weight loss focus, competitive comparisons, political topics"></textarea>
                    <div class="helper-text">Help us stay aligned with your values</div>
                </div>

                <div class="form-group">
                    <label>Any current promotions or events to mention? (Optional):</label>
                    <textarea name="promotions" rows="2" placeholder="e.g., New Year special: 50% off first month, Open House this Saturday"></textarea>
                </div>

                <div class="form-group">
                    <label>Link to your Instagram/social profile (Optional):</label>
                    <input type="url" name="social_profile" placeholder="https://instagram.com/yourusername">
                    <div class="helper-text">Helps AI understand your existing content style</div>
                </div>

                <!-- SECTION 3.5: INSTRUCTOR MANAGEMENT (Studio Owner only) -->
                <div class="instructor-management" id="instructor-management">
                    <h3>üë• Manage Your Instructors</h3>
                    <p style="font-size: 13px; color: #64748b; margin-bottom: 15px;">
                        Add your instructors here so you can tag photos for them later. <strong>This section is optional</strong> - you can generate content without adding instructors.
                    </p>
                    <div class="add-instructor-form">
                        <input type="text" id="new-instructor-name" placeholder="Instructor Name">
                        <input type="email" id="new-instructor-email" placeholder="instructor@email.com">
                        <button type="button" class="add-instructor-btn" id="add-instructor-btn">+ Add</button>
                    </div>
                    <div class="instructor-list" id="instructor-list"></div>
                </div>

                <!-- SECTION 3.6: PHOTO UPLOAD (Pro/Premium/Studio Owner/Trial only) -->
                <div id="photo-section" class="form-group hidden">
                    <div class="section-header">Your Photos (Optional)</div>
                    
                    <div class="photo-upload-section" id="photo-upload-area">
                        <input type="file" id="photo-input" accept="image/*" multiple style="display: none;">
                        <div id="upload-prompt">
                            <p style="font-size: 18px; margin-bottom: 10px;">üì∏ Upload Your Photos</p>
                            <p style="font-size: 14px; color: #64748b;">Click to select photos or drag & drop</p>
                            <p style="font-size: 12px; color: #94a3b8; margin-top: 8px;">Accepted: JPG, PNG (max 25MB each)</p>
                        </div>
                    </div>
                    
                    <div id="photo-preview-grid" class="photo-preview-grid"></div>
                    
                    <div class="helper-text" style="margin-top: 15px;">
                        Upload 5-20 photos. Tag them for specific instructors or leave untagged for general studio use.
                    </div>
                    
                   <!-- Prefer Own Photos Toggle -->
<div class="toggle-group" style="margin-top: 20px;">
    <div>
        <div class="toggle-label">Only Use My Own Photos</div>
        <div class="toggle-description">
            <strong>ON:</strong> Only use my uploaded photos. Never generate AI images, even if no photo matches.<br>
            <strong>OFF:</strong> Use my photos when available, but generate AI images when no matching photo is found.
        </div>
    </div>
    <label class="toggle-switch">
        <input type="checkbox" name="preferOwnPhotos" id="preferOwnPhotos" checked>
        <span class="toggle-slider"></span>
    </label>
</div>
                
                <!-- SECTION 4: PLATFORMS -->
                <div class="section-header">Social Media Platforms & Post Settings</div>

                <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;">
                    Select platforms and choose how many posts you want (click the number).
                </p>
                
                <!-- Instagram -->
                <div class="platform-card" id="instagram-card">
                    <div class="platform-header">
                        <input type="checkbox" id="instagram-enabled" onchange="handlePlatformToggle('instagram')">
                        <label for="instagram-enabled">üì∏ Instagram</label>
                    </div>
                    <div class="platform-controls" id="instagram-controls">
                        <div class="control-row">
                            <div class="control-item">
                                <label>Number of Posts:</label>
                                <div class="number-selector" id="instagram-posts-selector">
                                    <div class="number-btn" data-value="0">0</div>
                                    <div class="number-btn" data-value="1">1</div>
                                    <div class="number-btn" data-value="2">2</div>
                                    <div class="number-btn selected" data-value="3">3</div>
                                    <div class="number-btn" data-value="4">4</div>
                                    <div class="number-btn" data-value="5">5</div>
                                </div>
                                <input type="hidden" name="instagram_posts" value="3">
                            </div>
                            <div class="control-item" style="margin-top: 12px;">
                                <label>Include Images:</label>
                                <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                                    <label class="toggle-switch" style="margin: 0;">
                                        <input type="checkbox" name="instagram_images" id="instagram_images" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span style="font-size: 13px; color: #64748b;" id="instagram-image-label">Images ON</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Facebook -->
                <div class="platform-card" id="facebook-card">
                    <div class="platform-header">
                        <input type="checkbox" id="facebook-enabled" onchange="handlePlatformToggle('facebook')">
                        <label for="facebook-enabled">üë• Facebook</label>
                    </div>
                    <div class="platform-controls" id="facebook-controls">
                        <div class="control-row">
                            <div class="control-item">
                                <label>Number of Posts:</label>
                                <div class="number-selector" id="facebook-posts-selector">
                                    <div class="number-btn" data-value="0">0</div>
                                    <div class="number-btn" data-value="1">1</div>
                                    <div class="number-btn" data-value="2">2</div>
                                    <div class="number-btn selected" data-value="3">3</div>
                                    <div class="number-btn" data-value="4">4</div>
                                    <div class="number-btn" data-value="5">5</div>
                                </div>
                                <input type="hidden" name="facebook_posts" value="3">
                            </div>
                            <div class="control-item" style="margin-top: 12px;">
                                <label>Include Images:</label>
                                <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                                    <label class="toggle-switch" style="margin: 0;">
                                        <input type="checkbox" name="facebook_images" id="facebook_images" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span style="font-size: 13px; color: #64748b;" id="facebook-image-label">Images ON</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LinkedIn -->
                <div class="platform-card" id="linkedin-card">
                    <div class="platform-header">
                        <input type="checkbox" id="linkedin-enabled" onchange="handlePlatformToggle('linkedin')">
                        <label for="linkedin-enabled">üíº LinkedIn</label>
                    </div>
                    <div class="platform-controls" id="linkedin-controls">
                        <div class="control-row">
                            <div class="control-item">
                                <label>Number of Posts:</label>
                                <div class="number-selector" id="linkedin-posts-selector">
                                    <div class="number-btn" data-value="0">0</div>
                                    <div class="number-btn" data-value="1">1</div>
                                    <div class="number-btn selected" data-value="2">2</div>
                                    <div class="number-btn" data-value="3">3</div>
                                    <div class="number-btn" data-value="4">4</div>
                                    <div class="number-btn" data-value="5">5</div>
                                </div>
                                <input type="hidden" name="linkedin_posts" value="2">
                            </div>
                            <div class="control-item" style="margin-top: 12px;">
                                <label>Include Images:</label>
                                <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                                    <label class="toggle-switch" style="margin: 0;">
                                        <input type="checkbox" name="linkedin_images" id="linkedin_images">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span style="font-size: 13px; color: #64748b;" id="linkedin-image-label">Images OFF</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Twitter/X -->
                <div class="platform-card" id="twitter-card">
                    <div class="platform-header">
                        <input type="checkbox" id="twitter-enabled" onchange="handlePlatformToggle('twitter')">
                        <label for="twitter-enabled">ùïè Twitter/X</label>
                    </div>
                    <div class="platform-controls" id="twitter-controls">
                        <div class="control-row">
                            <div class="control-item">
                                <label>Number of Posts:</label>
                                <div class="number-selector" id="twitter-posts-selector">
                                    <div class="number-btn" data-value="0">0</div>
                                    <div class="number-btn" data-value="1">1</div>
                                    <div class="number-btn" data-value="2">2</div>
                                    <div class="number-btn" data-value="3">3</div>
                                    <div class="number-btn" data-value="4">4</div>
                                    <div class="number-btn selected" data-value="5">5</div>
                                </div>
                                <input type="hidden" name="twitter_posts" value="5">
                            </div>
                            <div class="control-item" style="margin-top: 12px;">
                                <label>Include Images:</label>
                                <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                                    <label class="toggle-switch" style="margin: 0;">
                                        <input type="checkbox" name="twitter_images" id="twitter_images">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span style="font-size: 13px; color: #64748b;" id="twitter-image-label">Images OFF</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TikTok (Coming Soon) -->
                <div class="platform-card disabled" id="tiktok-card">
                    <div class="platform-header">
                        <input type="checkbox" id="tiktok-enabled" onchange="handlePlatformToggle('tiktok')" disabled>
                        <label for="tiktok-enabled" style="opacity: 0.6;">üéµ TikTok <span style="background: #fbbf24; color: #78350f; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">COMING SOON</span></label>
                    </div>
                    <div class="platform-controls" id="tiktok-controls">
                        <div class="control-row">
                            <div class="control-item">
                                <label>Number of Script Ideas:</label>
                                <div class="number-selector" id="tiktok-posts-selector">
                                    <div class="number-btn" data-value="0">0</div>
                                    <div class="number-btn" data-value="1">1</div>
                                    <div class="number-btn" data-value="2">2</div>
                                    <div class="number-btn selected" data-value="3">3</div>
                                    <div class="number-btn" data-value="4">4</div>
                                    <div class="number-btn" data-value="5">5</div>
                                </div>
                                <input type="hidden" name="tiktok_posts" value="3">
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #64748b; margin-top: 8px;">
                            Note: Video reel creation coming soon
                        </p>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" id="submit-btn">üöÄ Generate My Content</button>
                
                <!-- Clear Saved Data Button -->
                <button type="button" id="clear-data-btn" style="
                    width: 100%;
                    padding: 12px;
                    background: transparent;
                    color: #64748b;
                    border: 2px solid #e2e8f0;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    margin-top: 12px;
                    transition: all 0.2s ease;
                    display: none;
                " onmouseover="this.style.borderColor='#f97316'; this.style.color='#f97316';" onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#64748b';">
                    üóëÔ∏è Clear Saved Form Data
                </button>
            </div>
        </form>
    </div>
    
    <script type="module">
        // Supabase configuration
        const SUPABASE_URL = 'https://kidgcrqxrfcbsaeguwop.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpZGdjcnF4cmZjYnNhZWd1d29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MzY5MzQsImV4cCI6MjA3NDIxMjkzNH0.7u__bKIRGD7xt3JcoME2CBjIF7dGdkqE24IQ26hCe3k';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let userTierData = null;
        let uploadedPhotos = []; // Array of {file, dataUrl, taggedInstructors[]}
        let studioInstructors = [];
        
        // localStorage key - store per email
        const getStorageKey = (email) => `fca_form_data_${email}`;
        
        // Auto-save form data
        function saveFormData(email) {
            if (!email) return;
            
            const formData = {
                saved_at: new Date().toISOString(),
                
                // Text inputs
                client_type: document.querySelector('[name="client_type"]')?.value || '',
                brand_voice: document.querySelector('[name="brand_voice"]')?.value || '',
                unique_value: document.querySelector('[name="unique_value"]')?.value || '',
                primary_goal: document.querySelector('[name="primary_goal"]')?.value || '',
                signature_style: document.querySelector('[name="signature_style"]')?.value || '',
                target_audience: document.querySelector('[name="target_audience"]')?.value || '',
                fitness_focus: document.querySelector('[name="fitness_focus"]')?.value || '',
                cta_type: document.querySelector('[name="cta_type"]')?.value || '',
                custom_cta: document.querySelector('[name="custom_cta"]')?.value || '',
                caption_style: document.querySelector('[name="caption_style"]')?.value || '',
                hashtag_preference: document.querySelector('[name="hashtag_preference"]')?.value || '',
                custom_hashtags: document.querySelector('[name="custom_hashtags"]')?.value || '',
                avoid_topics: document.querySelector('[name="avoid_topics"]')?.value || '',
                promotions: document.querySelector('[name="promotions"]')?.value || '',
                social_profile: document.querySelector('[name="social_profile"]')?.value || '',
                
                // Photo preferences
                preferOwnPhotos: document.getElementById('preferOwnPhotos')?.checked ?? true,
                
                // Content themes checkboxes
                content_themes: Array.from(document.querySelectorAll('[name="content_themes"]:checked'))
                    .map(cb => cb.value),
                
                // Platform states
                platforms: {
                    instagram: {
                        enabled: document.getElementById('instagram-enabled')?.checked || false,
                        posts: document.querySelector('[name="instagram_posts"]')?.value || '3',
                        images: document.getElementById('instagram_images')?.checked ?? true
                    },
                    facebook: {
                        enabled: document.getElementById('facebook-enabled')?.checked || false,
                        posts: document.querySelector('[name="facebook_posts"]')?.value || '3',
                        images: document.getElementById('facebook_images')?.checked ?? true
                    },
                    linkedin: {
                        enabled: document.getElementById('linkedin-enabled')?.checked || false,
                        posts: document.querySelector('[name="linkedin_posts"]')?.value || '2',
                        images: document.getElementById('linkedin_images')?.checked ?? false
                    },
                    twitter: {
                        enabled: document.getElementById('twitter-enabled')?.checked || false,
                        posts: document.querySelector('[name="twitter_posts"]')?.value || '5',
                        images: document.getElementById('twitter_images')?.checked ?? false
                    },
                    tiktok: {
                        enabled: document.getElementById('tiktok-enabled')?.checked || false,
                        posts: document.querySelector('[name="tiktok_posts"]')?.value || '3',
                        images: false
                    }
                }
            };
            
            try {
                localStorage.setItem(getStorageKey(email), JSON.stringify(formData));
                console.log('‚úÖ Form data saved for', email);
            } catch (e) {
                console.error('Error saving form data:', e);
            }
        }
        
        // Load saved form data
        function loadFormData(email) {
            if (!email) return false;
            
            try {
                const savedData = localStorage.getItem(getStorageKey(email));
                if (!savedData) {
                    console.log('No saved data for', email);
                    return false;
                }
                
                const formData = JSON.parse(savedData);
                console.log('üì• Loading saved data from', formData.saved_at);
                
                // Load text inputs and selects
                Object.keys(formData).forEach(key => {
                    if (key === 'saved_at' || key === 'content_themes' || key === 'platforms' || key === 'preferOwnPhotos') return;
                    
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element && formData[key]) {
                        element.value = formData[key];
                        
                        // Trigger custom CTA display if needed
                        if (key === 'cta_type' && formData[key] === 'custom') {
                            document.getElementById('custom-cta-group').style.display = 'block';
                        }
                    }
                });
                
                // Load preferOwnPhotos checkbox
                if (formData.preferOwnPhotos !== undefined) {
                    const preferOwnPhotosCheckbox = document.getElementById('preferOwnPhotos');
                    if (preferOwnPhotosCheckbox) {
                        preferOwnPhotosCheckbox.checked = formData.preferOwnPhotos;
                    }
                }
                
                // Load content themes checkboxes
                if (formData.content_themes) {
                    formData.content_themes.forEach(theme => {
                        const checkbox = document.querySelector(`[name="content_themes"][value="${theme}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                // Load platform states
                if (formData.platforms) {
                    Object.keys(formData.platforms).forEach(platform => {
                        const platformData = formData.platforms[platform];
                        
                        // Set checkbox
                        const checkbox = document.getElementById(`${platform}-enabled`);
                        if (checkbox) {
                            checkbox.checked = platformData.enabled;
                            handlePlatformToggle(platform);
                        }
                        
                        // Set post count
                        const hiddenInput = document.querySelector(`[name="${platform}_posts"]`);
                        if (hiddenInput) {
                            hiddenInput.value = platformData.posts;
                        }
                        
                        // Set image toggle
                        const imageToggle = document.getElementById(`${platform}_images`);
                        if (imageToggle && platformData.images !== undefined) {
                            imageToggle.checked = platformData.images;
                            // Update label
                            const label = document.getElementById(`${platform}-image-label`);
                            if (label) {
                                label.textContent = platformData.images ? 'Images ON' : 'Images OFF';
                            }
                        }
                        
                        // Update number selector buttons
                        const selector = document.getElementById(`${platform}-posts-selector`);
                        if (selector) {
                            const buttons = selector.querySelectorAll('.number-btn');
                            buttons.forEach(btn => {
                                btn.classList.remove('selected');
                                if (btn.dataset.value === platformData.posts) {
                                    btn.classList.add('selected');
                                }
                            });
                        }
                    });
                }
                
                return true;
            } catch (e) {
                console.error('Error loading form data:', e);
                return false;
            }
        }
        
        // Clear saved form data
        function clearSavedData(email) {
            if (!email) return;
            
            try {
                localStorage.removeItem(getStorageKey(email));
                console.log('üóëÔ∏è Cleared saved data for', email);
            } catch (e) {
                console.error('Error clearing form data:', e);
            }
        }

        // Enable auto-save for form inputs
        function enableAutoSave(email) {
            if (!email) return;
            
            console.log('üîÑ Auto-save enabled for', email);
            
            // Show clear button if there's saved data
            const clearBtn = document.getElementById('clear-data-btn');
            if (localStorage.getItem(getStorageKey(email))) {
                clearBtn.style.display = 'block';
            }
            
            // Save on any input change
            const form = document.getElementById('contentForm');
            
            form.addEventListener('input', () => saveFormData(email));
            form.addEventListener('change', () => saveFormData(email));
            
            // Save when platform toggles
            document.querySelectorAll('[id$="-enabled"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => saveFormData(email));
            });
            
            // Save when number selectors change
            document.querySelectorAll('.number-btn').forEach(btn => {
                btn.addEventListener('click', () => saveFormData(email));
            });
            
            // Save when photo preference toggle changes
            const preferOwnPhotosToggle = document.getElementById('preferOwnPhotos');
            if (preferOwnPhotosToggle) {
                preferOwnPhotosToggle.addEventListener('change', () => saveFormData(email));
            }
        }

        // Clear saved data button handler
        document.getElementById('clear-data-btn').addEventListener('click', function() {
            if (!userTierData || !userTierData.email) {
                alert('No email detected');
                return;
            }
            
            if (confirm('Are you sure you want to clear your saved form data? This will reset all fields to default.')) {
                clearSavedData(userTierData.email);
                
                // Reset form
                document.getElementById('contentForm').reset();
                
                // Reset number selectors to defaults
                const defaults = {'instagram': '3', 'facebook': '3', 'linkedin': '2', 'twitter': '5', 'tiktok': '3'};
                const imageDefaults = {'instagram': true, 'facebook': true, 'linkedin': false, 'twitter': false, 'tiktok': false};
                
                Object.keys(defaults).forEach(platform => {
                    const selector = document.getElementById(`${platform}-posts-selector`);
                    if (selector) {
                        const buttons = selector.querySelectorAll('.number-btn');
                        buttons.forEach(btn => {
                            btn.classList.remove('selected');
                            if (btn.dataset.value === defaults[platform]) {
                                btn.classList.add('selected');
                            }
                        });
                    }
                    
                    // Reset image toggles
                    const imageToggle = document.getElementById(`${platform}_images`);
                    if (imageToggle) {
                        imageToggle.checked = imageDefaults[platform];
                        const label = document.getElementById(`${platform}-image-label`);
                        if (label) {
                            label.textContent = imageDefaults[platform] ? 'Images ON' : 'Images OFF';
                        }
                    }
                });
                
                // Reset uploaded photos
                uploadedPhotos = [];
                renderPhotoPreview();
                
                // Hide clear button
                this.style.display = 'none';
                
                alert('‚úÖ Form data cleared! Fill out the form fresh.');
            }
        });

        // Email verification
        const emailInput = document.getElementById('email');
        const verifyEmailBtn = document.getElementById('verify-email-btn');
        const tierInfo = document.getElementById('tier-info');
        const mainForm = document.getElementById('main-form');
        const photoSection = document.getElementById('photo-section');
        const instructorManagement = document.getElementById('instructor-management');

        // Verify email on button click
        verifyEmailBtn.addEventListener('click', async function() {
            const email = emailInput.value.trim().toLowerCase();
            if (!email || !email.includes('@')) {
                tierInfo.innerHTML = '<p style="color: #b91c1c;">Please enter a valid email address</p>';
                tierInfo.classList.add('show');
                return;
            }

            // Show loading on button
            verifyEmailBtn.disabled = true;
            verifyEmailBtn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</span> Checking account...';
            
            // Show loading in tier info
            tierInfo.innerHTML = '<p>Checking your account...</p>';
            tierInfo.classList.add('show');

            try {
                await checkUserTier(email);
            } catch (error) {
                console.error('Error checking tier:', error);
                tierInfo.innerHTML = '<p style="color: #b91c1c;">Error loading account. Please try again.</p>';
            } finally {
                // Reset button
                verifyEmailBtn.disabled = false;
                verifyEmailBtn.innerHTML = 'Continue ‚Üí';
            }
        });
        
        // Also allow Enter key to trigger verification
        emailInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                verifyEmailBtn.click();
            }
        });

        async function checkUserTier(email) {
            let role = 'regular_client';
            let tierData = {};
            
            // First, ALWAYS get the client_id from clients table (this is the universal ID)
            const { data: clientData } = await supabaseClient
                .from('clients')
                .select('*')
                .eq('email', email)
                .single();

            if (!clientData) {
                // No account found
                tierInfo.className = 'tier-info expired show';
                tierInfo.innerHTML = `
                    <h3>üÜï New User?</h3>
                    <p>We couldn't find an account with this email.</p>
                    <p style="margin-top: 10px;"><a href="https://fca-signup.netlify.app" style="color: #0369a1; font-weight: 600;">Start Free Trial ‚Üí</a></p>
                `;
                return;
            }
            
            // Now we have the universal client_id from clients table
            const universalClientId = clientData.id;
            
            // Check 1: Studio Owner?
            const { data: studioOwnerData } = await supabaseClient
                .from('studio_accounts')
                .select('*')
                .eq('owner_email', email)
                .eq('subscription_status', 'active')
                .single();

            if (studioOwnerData) {
                // Fetch instructors for this studio
                const { data: instructorsData } = await supabaseClient
                    .from('studio_instructors')
                    .select('*')
                    .eq('studio_id', studioOwnerData.id)
                    .eq('status', 'active');

                studioInstructors = instructorsData || [];
                
                userTierData = {
                    tier: studioOwnerData.plan_type || 'pro',
                    role: 'studio_owner',
                    email: email,
                    client_id: universalClientId,
                    studio_id: studioOwnerData.id,
                    studio_name: studioOwnerData.studio_name
                };

                const hasSavedData = loadFormData(email);

                tierInfo.className = 'tier-info show';
                tierInfo.innerHTML = `
                    <h3>üè¢ Studio Owner</h3>
                    <p><strong>${userTierData.studio_name}</strong></p>
                    <p style="font-size: 13px; margin-top: 8px;">‚ú® Manage instructors and upload tagged photos</p>
                    ${hasSavedData ? '<p style="margin-top: 8px; font-size: 12px; color: #0369a1;">üìù Loaded your previous settings</p>' : ''}
                `;

                document.getElementById('client_id').value = userTierData.client_id;
                document.getElementById('user_tier').value = userTierData.tier;
                document.getElementById('user_role').value = 'studio_owner';
                document.getElementById('studio_id').value = userTierData.studio_id;
                document.getElementById('studio_name').value = userTierData.studio_name;
                
                photoSection.classList.remove('hidden');
                instructorManagement.classList.add('show');
                renderInstructorList();
                
                mainForm.style.display = 'block';
                enableAutoSave(email);
                return;
            }

            // Check 2: Trial user?
            const { data: trialData } = await supabaseClient
                .from('trials')
                .select('*')
                .eq('email', email)
                .single();

            if (trialData) {
                const postsUsed = trialData.content_count || 0;
                const postsRemaining = 16 - postsUsed;
                const trialEnd = new Date(trialData.trial_end_date);
                const now = new Date();
                const isExpired = now > trialEnd;

                if (isExpired) {
                    tierInfo.className = 'tier-info expired show';
                    tierInfo.innerHTML = `
                        <h3>‚ö†Ô∏è Trial Expired</h3>
                        <p>Your 7-day trial has ended. Please subscribe to continue generating content.</p>
                        <p style="margin-top: 10px;"><a href="https://fiorsaoirse.com/pricing" style="color: #0369a1; font-weight: 600;">View Pricing Plans ‚Üí</a></p>
                    `;
                    return;
                }

                if (postsRemaining <= 0) {
                    tierInfo.className = 'tier-info expired show';
                    tierInfo.innerHTML = `
                        <h3>‚ö†Ô∏è Trial Limit Reached</h3>
                        <p>You've used all 16 trial posts. Subscribe to continue!</p>
                        <p style="margin-top: 10px;"><a href="https://fiorsaoirse.com/pricing" style="color: #0369a1; font-weight: 600;">View Pricing Plans ‚Üí</a></p>
                    `;
                    return;
                }

                userTierData = {
                    tier: 'trial',
                    role: 'trial_user',
                    email: email,
                    client_id: universalClientId,
                    posts_remaining: postsRemaining,
                    trial_end: trialEnd.toLocaleDateString()
                };

                const hasSavedData = loadFormData(email);
                
                tierInfo.className = 'tier-info trial show';
                tierInfo.innerHTML = `
                    <h3>üéâ Trial Account</h3>
                    <p><strong>${postsRemaining} posts remaining</strong> (${postsUsed}/16 used)</p>
                    <p>Trial ends: ${userTierData.trial_end}</p>
                    <p style="margin-top: 8px; font-size: 13px;">‚ú® AI images included in trial!</p>
                    ${hasSavedData ? '<p style="margin-top: 8px; font-size: 12px; color: #047857;">üìù Loaded your previous settings</p>' : ''}
                `;

                document.getElementById('client_id').value = userTierData.client_id;
                document.getElementById('user_tier').value = 'trial';
                document.getElementById('user_role').value = 'trial_user';
                document.getElementById('posts_remaining').value = postsRemaining;
                photoSection.classList.remove('hidden');
                instructorManagement.classList.remove('show');
                mainForm.style.display = 'block';
                
                enableAutoSave(email);
                return;
            }

            // Check 3: Studio instructor?
            const { data: instructorData } = await supabaseClient
                .from('studio_instructors')
                .select('*, studio_accounts(*)')
                .eq('instructor_email', email)
                .eq('status', 'active')
                .single();

            if (instructorData) {
                userTierData = {
                    tier: 'studio_instructor',
                    role: 'studio_instructor',
                    email: email,
                    client_id: universalClientId,
                    studio_id: instructorData.studio_id,
                    studio_name: instructorData.studio_accounts.studio_name
                };

                const hasSavedData = loadFormData(email);

                tierInfo.className = 'tier-info show';
                tierInfo.innerHTML = `
                    <h3>üè¢ Studio Instructor</h3>
                    <p>Connected to: <strong>${userTierData.studio_name}</strong></p>
                    <p style="font-size: 13px; margin-top: 8px;">‚ú® Access to studio photo library</p>
                    ${hasSavedData ? '<p style="margin-top: 8px; font-size: 12px; color: #0369a1;">üìù Loaded your previous settings</p>' : ''}
                `;

                document.getElementById('client_id').value = userTierData.client_id;
                document.getElementById('user_tier').value = 'studio_instructor';
                document.getElementById('user_role').value = 'studio_instructor';
                document.getElementById('studio_id').value = userTierData.studio_id;
                document.getElementById('studio_name').value = userTierData.studio_name;
                photoSection.classList.add('hidden'); // Studio instructors don't upload
                instructorManagement.classList.remove('show');
                mainForm.style.display = 'block';
                
                enableAutoSave(email);
                return;
            }

            // Check 4: Regular paid subscriber (already have clientData from above)
            if (clientData.subscription_status === 'active') {
                const tier = clientData.plan_type || 'basic';
                
                userTierData = {
                    tier: tier,
                    role: 'regular_client',
                    email: email,
                    client_id: universalClientId
                };

                const tierLabels = {
                    basic: { name: 'Basic', color: 'tier-basic', icon: '‚≠ê' },
                    pro: { name: 'Pro', color: 'tier-pro', icon: 'üî•' },
                    premium: { name: 'Premium', color: 'tier-premium', icon: 'üíé' }
                };

                const tierInfo_config = tierLabels[tier] || tierLabels.basic;
                
                const hasSavedData = loadFormData(email);

                tierInfo.className = `tier-info show`;
                tierInfo.innerHTML = `
                    <h3>${tierInfo_config.icon} ${tierInfo_config.name} Subscriber</h3>
                    <p>Full access to all features</p>
                    ${tier === 'pro' || tier === 'premium' ? '<p style="font-size: 13px; margin-top: 8px;">‚ú® Photo upload enabled</p>' : ''}
                    ${hasSavedData ? '<p style="margin-top: 8px; font-size: 12px; color: #0369a1;">üìù Loaded your previous settings</p>' : ''}
                `;

                document.getElementById('client_id').value = userTierData.client_id;
                document.getElementById('user_tier').value = tier;
                document.getElementById('user_role').value = 'regular_client';
                
                if (tier === 'pro' || tier === 'premium') {
                    photoSection.classList.remove('hidden');
                } else {
                    photoSection.classList.add('hidden');
                }

                instructorManagement.classList.remove('show');
                mainForm.style.display = 'block';
                enableAutoSave(email);
                return;
            }

            // Should not reach here if they're in clients table
            tierInfo.className = 'tier-info expired show';
            tierInfo.innerHTML = `
                <h3>‚ö†Ô∏è Account Issue</h3>
                <p>Your account exists but is not active. Please contact support.</p>
            `;
        }

        // Render instructor management list
        function renderInstructorList() {
            const instructorList = document.getElementById('instructor-list');
            
            if (studioInstructors.length === 0) {
                instructorList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No instructors yet. Add your first instructor above!</p>';
                return;
            }

            instructorList.innerHTML = studioInstructors.map(instructor => `
                <div class="instructor-item">
                    <div class="instructor-info">
                        <div class="instructor-name">${instructor.instructor_name || 'Unnamed'}</div>
                        <div class="instructor-email">${instructor.instructor_email}</div>
                    </div>
                    <button type="button" class="remove-instructor-btn" onclick="removeInstructor('${instructor.id}')">Remove</button>
                </div>
            `).join('');

            // Re-render photo preview to update instructor checkboxes
            renderPhotoPreview();
        }

        // Add instructor
        document.getElementById('add-instructor-btn').addEventListener('click', async function() {
            const name = document.getElementById('new-instructor-name').value.trim();
            const email = document.getElementById('new-instructor-email').value.trim().toLowerCase();

            if (!name || !email) {
                alert('Please enter both name and email');
                return;
            }

            if (!email.includes('@')) {
                alert('Please enter a valid email');
                return;
            }

            document.getElementById('loading-overlay').classList.add('show');

            try {
                // Add to studio_instructors table
                const { data, error } = await supabaseClient
                    .from('studio_instructors')
                    .insert({
                        studio_id: userTierData.studio_id,
                        instructor_email: email,
                        instructor_name: name,
                        status: 'active'
                    })
                    .select()
                    .single();

                if (error) throw error;

                // Add to local array
                studioInstructors.push(data);
                
                // Re-render list
                renderInstructorList();

                // Clear inputs
                document.getElementById('new-instructor-name').value = '';
                document.getElementById('new-instructor-email').value = '';

                alert(`‚úÖ ${name} added successfully!`);
            } catch (error) {
                console.error('Error adding instructor:', error);
                alert('Error adding instructor: ' + error.message);
            } finally {
                document.getElementById('loading-overlay').classList.remove('show');
            }
        });

        // Remove instructor
        window.removeInstructor = async function(instructorId) {
            if (!confirm('Are you sure you want to remove this instructor?')) return;

            document.getElementById('loading-overlay').classList.add('show');

            try {
                // Set status to inactive
                await supabaseClient
                    .from('studio_instructors')
                    .update({ status: 'inactive' })
                    .eq('id', instructorId);

                // Remove from local array
                studioInstructors = studioInstructors.filter(i => i.id !== instructorId);
                
                // Re-render list
                renderInstructorList();

                alert('‚úÖ Instructor removed!');
            } catch (error) {
                console.error('Error removing instructor:', error);
                alert('Error removing instructor: ' + error.message);
            } finally {
                document.getElementById('loading-overlay').classList.remove('show');
            }
        };

        // Photo upload handling
        const photoInput = document.getElementById('photo-input');
        const photoUploadArea = document.getElementById('photo-upload-area');
        const photoPreviewGrid = document.getElementById('photo-preview-grid');

        photoUploadArea.addEventListener('click', () => {
            if (!photoUploadArea.classList.contains('disabled')) {
                photoInput.click();
            }
        });

        photoInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.size > 25 * 1024 * 1024) {
                    alert(`${file.name} is too large (max 25MB)`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedPhotos.push({
                        file: file,
                        dataUrl: event.target.result,
                        taggedInstructors: [] // Empty by default
                    });
                    renderPhotoPreview();
                };
                reader.readAsDataURL(file);
            });
        });

        function renderPhotoPreview() {
            if (uploadedPhotos.length === 0) {
                document.getElementById('upload-prompt').style.display = 'block';
                photoPreviewGrid.innerHTML = '';
                return;
            }

            document.getElementById('upload-prompt').style.display = 'none';
            
            const isStudioOwner = userTierData && userTierData.role === 'studio_owner';
            
            photoPreviewGrid.innerHTML = uploadedPhotos.map((photo, photoIndex) => `
                <div class="photo-preview-card">
                    <div class="photo-preview-image">
                        <img src="${photo.dataUrl}" alt="Photo ${photoIndex + 1}">
                        <button type="button" class="photo-remove-btn" onclick="removePhoto(${photoIndex})">√ó</button>
                    </div>
                    ${isStudioOwner && studioInstructors.length > 0 ? `
                        <div class="photo-tags">
                            <label class="photo-tags-label">Tag for instructors:</label>
                            <div class="photo-instructor-checkboxes">
                                ${studioInstructors.map((instructor, instructorIndex) => `
                                    <div class="photo-instructor-checkbox">
                                        <input 
                                            type="checkbox" 
                                            id="photo-${photoIndex}-instructor-${instructorIndex}" 
                                            value="${instructor.instructor_email}"
                                            ${photo.taggedInstructors.includes(instructor.instructor_email) ? 'checked' : ''}
                                            onchange="updatePhotoTag(${photoIndex}, '${instructor.instructor_email}', this.checked)"
                                        >
                                        <label for="photo-${photoIndex}-instructor-${instructorIndex}">${instructor.instructor_name}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        window.updatePhotoTag = function(photoIndex, instructorEmail, isChecked) {
            if (isChecked) {
                if (!uploadedPhotos[photoIndex].taggedInstructors.includes(instructorEmail)) {
                    uploadedPhotos[photoIndex].taggedInstructors.push(instructorEmail);
                }
            } else {
                uploadedPhotos[photoIndex].taggedInstructors = uploadedPhotos[photoIndex].taggedInstructors.filter(
                    email => email !== instructorEmail
                );
            }
        };

        window.removePhoto = function(index) {
            uploadedPhotos.splice(index, 1);
            renderPhotoPreview();
        };

        // Initialize number selectors
        document.querySelectorAll('.number-selector').forEach(selector => {
            const buttons = selector.querySelectorAll('.number-btn');
            const platformName = selector.id.replace('-posts-selector', '');
            const hiddenInput = document.querySelector(`input[name="${platformName}_posts"]`);
            
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    buttons.forEach(btn => btn.classList.remove('selected'));
                    this.classList.add('selected');
                    hiddenInput.value = this.dataset.value;
                });
            });
        });
        
        // Handle image toggle label updates
        const platformImageToggles = ['instagram', 'facebook', 'linkedin', 'twitter'];
        platformImageToggles.forEach(platform => {
            const toggle = document.getElementById(`${platform}_images`);
            const label = document.getElementById(`${platform}-image-label`);
            if (toggle && label) {
                toggle.addEventListener('change', function() {
                    label.textContent = this.checked ? 'Images ON' : 'Images OFF';
                });
            }
        });

        // Handle platform toggle
        window.handlePlatformToggle = function(platform) {
            const checkbox = document.getElementById(`${platform}-enabled`);
            const controls = document.getElementById(`${platform}-controls`);
            const card = document.getElementById(`${platform}-card`);
            
            if (checkbox.checked) {
                controls.classList.add('active');
                card.classList.remove('disabled');
            } else {
                controls.classList.remove('active');
                card.classList.add('disabled');
            }
        };

        // Handle custom CTA display
        document.getElementById('cta_type').addEventListener('change', function() {
            const customCtaGroup = document.getElementById('custom-cta-group');
            if (this.value === 'custom') {
                customCtaGroup.style.display = 'block';
            } else {
                customCtaGroup.style.display = 'none';
            }
        });

        // Form submission
        document.getElementById('contentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!userTierData) {
                alert('Please enter your email first to verify your account');
                return;
            }

            const platforms = ['instagram', 'facebook', 'linkedin', 'twitter', 'tiktok'];
            const selectedPlatforms = platforms.filter(p => 
                document.getElementById(`${p}-enabled`).checked
            );
            
            if (selectedPlatforms.length === 0) {
                alert('Please select at least one social media platform');
                return;
            }
            
            const formData = new FormData(e.target);
            
            const platformsArray = [];
            selectedPlatforms.forEach(platform => {
                const postCount = parseInt(document.querySelector(`input[name="${platform}_posts"]`).value) || 3;
                
                if (postCount === 0) return;
                
                const imageToggle = document.getElementById(`${platform}_images`);
                const includeImages = imageToggle ? imageToggle.checked : true;
                
                const platformData = {
                    name: platform,
                    postCount: postCount,
                    includeImages: includeImages
                };
                
                platformsArray.push(platformData);
            });

            if (platformsArray.length === 0) {
                alert('Please select at least 1 post for at least one platform');
                return;
            }

            // Upload photos based on user role
            let photoData = null;
            
            if (uploadedPhotos.length > 0) {
                document.getElementById('loading-overlay').classList.add('show');
                
                const photoResults = [];
                
                for (const photo of uploadedPhotos) {
                    try {
                        if (userTierData.role === 'studio_owner') {
                            // Studio Owner: Upload to studio-photos bucket
                            const fileName = `studio-${userTierData.studio_id}/${Date.now()}-${photo.file.name}`;
                            const { data, error } = await supabaseClient.storage
                                .from('studio-photos')
                                .upload(fileName, photo.file);
                            
                            if (error) throw error;
                            
                            const { data: urlData } = supabaseClient.storage
                                .from('studio-photos')
                                .getPublicUrl(fileName);
                            
                            // Insert into studio_photos table with per-photo tags
                            await supabaseClient
                                .from('studio_photos')
                                .insert({
                                    studio_id: userTierData.studio_id,
                                    storage_path: fileName,
                                    storage_url: urlData.publicUrl,
                                    instructor_emails: photo.taggedInstructors.length > 0 ? photo.taggedInstructors : null, // null = general use
                                    uploaded_by: userTierData.email
                                });
                            
                            photoResults.push({
                                url: urlData.publicUrl,
                                tagged_instructors: photo.taggedInstructors.length > 0 ? photo.taggedInstructors : null
                            });
                            
                        } else if (userTierData.role === 'regular_client' || userTierData.role === 'trial_user') {
                            // Regular client or trial: Upload to client-photos bucket
                            const fileName = `${userTierData.email}/${Date.now()}-${photo.file.name}`;
                            const { data, error } = await supabaseClient.storage
                                .from('client-photos')
                                .upload(fileName, photo.file);
                            
                            if (error) throw error;
                            
                            const { data: urlData } = supabaseClient.storage
                                .from('client-photos')
                                .getPublicUrl(fileName);
                            
                            photoResults.push({
                                url: urlData.publicUrl,
                                tagged_instructors: null
                            });
                        }
                    } catch (error) {
                        console.error('Photo upload error:', error);
                    }
                }
                
                photoData = {
                    type: userTierData.role === 'studio_owner' ? 'studio_photos' : 'client_images',
                    studio_id: userTierData.studio_id || null,
                    photos: photoResults // Array of {url, tagged_instructors}
                };
            }

            const contentThemes = Array.from(document.querySelectorAll('input[name="content_themes"]:checked'))
                .map(cb => cb.value);

            const ctaType = formData.get('cta_type');
            const cta = ctaType === 'custom' ? formData.get('custom_cta') : ctaType;
            
            const data = {
                // User account info
                email: userTierData.email,
                client_id: userTierData.client_id || null,
                user_tier: userTierData.tier,
                user_role: userTierData.role,
                studio_id: userTierData.studio_id || null,
                studio_name: userTierData.studio_name || null,
                posts_remaining: userTierData.posts_remaining || null,
                
                // Form data
                client_type: formData.get('client_type'),
                brand_voice: formData.get('brand_voice'),
                unique_value: formData.get('unique_value') || '',
                primary_goal: formData.get('primary_goal'),
                signature_style: formData.get('signature_style') || '',
                target_audience: formData.get('target_audience'),
                fitness_focus: formData.get('fitness_focus'),
                cta: cta,
                content_themes: contentThemes,
                caption_style: formData.get('caption_style'),
                hashtag_preference: formData.get('hashtag_preference'),
                custom_hashtags: formData.get('custom_hashtags') || '',
                avoid_topics: formData.get('avoid_topics') || '',
                promotions: formData.get('promotions') || '',
                social_profile: formData.get('social_profile') || '',
                platforms: platformsArray,
                
                // Photo preferences
                preferOwnPhotos: document.getElementById('preferOwnPhotos')?.checked ?? true,
                
                // Photos
                photo_data: photoData
            };
            
            // Show loading
            document.getElementById('loading-overlay').classList.add('show');
            document.getElementById('submit-btn').disabled = true;
            
            try {
                // Send to n8n webhook
                await fetch('https://n8n.fiorsaoirse.com/webhook/fca-content-images', {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                // Hide loading
                document.getElementById('loading-overlay').classList.remove('show');
                
                // Show success banner
                document.getElementById('success-banner').classList.add('show');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Reset uploaded photos
                uploadedPhotos = [];
                renderPhotoPreview();
                
                // Re-enable submit after 30 seconds
                setTimeout(() => {
                    document.getElementById('submit-btn').disabled = false;
                }, 30000);
                
            } catch (error) {
                console.error('Submission error:', error);
                document.getElementById('loading-overlay').classList.remove('show');
                document.getElementById('submit-btn').disabled = false;
                
                // Even with error, likely succeeded due to no-cors
                document.getElementById('success-banner').classList.add('show');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
    </script>
</body>
</html>
